<template>
    <nav class="bg-gray-50 border-b border-gray-200 px-4 py-3" aria-label="breadcrumbs">
        <div class="container mx-auto">
            <ul class="flex space-x-4">
                <li>
                    <router-link to="/" class="text-blue-600 hover:text-blue-800">Home</router-link>
                </li>
                <li>
                    <a class="cursor-pointer text-gray-600">{{ lang }}</a>
                </li>
                <li class="text-gray-500" aria-current="page">
                    {{ article.Title }}
                </li>
            </ul>
        </div>
    </nav>
    <section class="bg-gray-100 text-black">
        <div class="container mx-auto py-8 px-4 text-center">
            <h1 class="text-3xl font-bold">{{ article.Title }}</h1>
            <p class="mt-4">{{ article.Description }}</p>
        </div>
    </section>
    <div class="container mx-auto flex py-8 px-4">
        <div class="w-1/4 pr-4">
            <aside class="sticky top-4 z-1">
                <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                    <p class="font-semibold mb-4">Navigation</p>
                    <ul class="space-y-2">
                        <li v-for="(heading, index) in headings" :key="index" :class="`pl-${heading.level * 2}`">
                            <a @click="scrollToHeading(heading.id)"
                                class="cursor-pointer text-blue-600 hover:text-blue-800">{{ heading.text }}</a>
                        </li>
                    </ul>
                    <a v-if="editUrl != ''" :href="editUrl" target="_blank"
                        class="mt-4 inline-block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Edit
                    </a>
                </div>
            </aside>
        </div>
        <div class="w-3/4 content prose" v-html="article.Body"></div>
    </div>
</template>


<script lang="ts">
import { defineComponent, watch } from "vue";
import type { Article, ChronosCollection, ChronosConfig } from "@/core/models";
import { useChronosStore } from "@/core/store";
import { useHead } from 'unhead';

export default defineComponent({
    name: "ArticleView",
    data() {
        return {
            article: {} as Article,
            lang: "",
            headings: [] as { text: string; id: string; level: number }[],
            chronosConfig: {} as ChronosConfig,
            collectionName: "",
            editUrl: "",
        };
    },
    computed: {
        chronosStore() {
            return useChronosStore();
        },
    },
    async mounted() {
        await this.initializeArticle();
        const collectionConfig = this.chronosConfig.chronosCollections.find(
            (c) => c.shortName === this.collectionName
        );

        this.setEditUrl(collectionConfig);
    },
    methods: {
        async initializeArticle() {
            // @ts-ignore
            this.chronosConfig = await this.$chronosAPI.config();
            this.collectionName = this.$route.params.collection as string;

            this.setupRouteWatcher();

            const lang = Array.isArray(this.$route.params.lang)
                ? this.$route.params.lang[0]
                : this.$route.params.lang;
            const slug = Array.isArray(this.$route.params.slug)
                ? this.$route.params.slug[0]
                : this.$route.params.slug;
            await this.loadArticle(lang, slug);

            this.chronosStore.$subscribe(() => {
                if (this.lang !== this.chronosStore.prefLang) {
                    this.loadArticleAndHandleResponse(this.chronosStore.prefLang);
                }
            });
        },
        async loadArticleAndHandleResponse(lang: string) {
            // @ts-ignore
            const response = await this.$chronosAPI.getArticleByLanguageAndSlug(
                lang,
                this.$route.params.slug,
                this.collectionName
            );
            this.handleArticleResponse(response, lang);
        },
        async loadArticle(lang: string, slug: string) {
            if (slug === undefined) {
                return;
            }

            // @ts-ignore
            const response = await this.$chronosAPI.getArticleByLanguageAndSlug(
                lang,
                slug,
                this.collectionName
            );
            this.handleArticleResponse(response, lang);
        },
        handleArticleResponse(response: Article, lang: string) {
            const { article, headings } = this.handleResponse(response);

            this.lang = lang;
            this.article = article;
            this.headings = headings;
            document.title = `${this.article!.Title} - ${this.chronosConfig.title}`;
        },
        handleResponse(response: Article) {
            let _article = response;
            _article.Body = this.setHeadingIds(_article.Body);
            let _headings = this.extractHeadings(_article.Body);

            useHead({
                title: `${this.article!.Title} - ${this.chronosConfig.title}`,
                meta: [
                    { name: "description", content: this.article!.Description },
                    { name: "og:title", content: `${this.article!.Title} - ${this.chronosConfig.title}` },
                    { name: "og:description", content: this.article!.Description },
                    { name: "og:url", content: `${this.chronosConfig.baseURL}/${this.article!.Slug}` },
                    { name: "twitter:card", content: "summary_large_image" },
                    { name: "twitter:title", content: `${this.article!.Title} - ${this.chronosConfig.title}` },
                    { name: "twitter:description", content: this.article!.Description },
                ],
            });

            return {
                article: _article,
                headings: _headings,
            };
        },
        setHeadingIds(body: string) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(body, "text/html");
            const hTags = doc.querySelectorAll("h1, h2, h3, h4, h5, h6");

            hTags.forEach((hTag) => {
                hTag.id = hTag.textContent?.replace(/\s+/g, "-").toLowerCase() as string;
            });

            return doc.body.innerHTML;
        },
        setupRouteWatcher() {
            watch(
                () => this.$route,
                async (newRoute, oldRoute) => {
                    if (newRoute.params.slug !== oldRoute.params.slug || newRoute.params.lang !== oldRoute.params.lang) {
                        const lang = Array.isArray(newRoute.params.lang)
                            ? newRoute.params.lang[0]
                            : newRoute.params.lang;
                        const slug = Array.isArray(newRoute.params.slug)
                            ? newRoute.params.slug[0]
                            : newRoute.params.slug;
                        await this.loadArticle(lang, slug);
                    }
                }
            );
        },
        setEditUrl(collectionConfig: ChronosCollection | undefined) {
            if (collectionConfig && collectionConfig.editUrl) {
                this.editUrl = collectionConfig.editUrl
                    .replace("{{lang}}", this.lang)
                    .replace("{{slug}}", this.article.Slug);
            }
        },
        extractHeadings(body: string) {
            const headings = [] as { text: string; id: string; level: number }[];
            const parser = new DOMParser();
            const doc = parser.parseFromString(body, "text/html");
            const hTags = doc.querySelectorAll("h1, h2, h3, h4, h5, h6");

            hTags.forEach((hTag) => {
                const level = parseInt(hTag.tagName.slice(1));
                const heading = {
                    text: hTag.textContent as string,
                    id: hTag.id,
                    level: level,
                };
                headings.push(heading);
            });

            return headings;
        },
        scrollToHeading(headingId: string) {
            const offset = 53;
            const element = document.getElementById(headingId);
            const y = element?.getBoundingClientRect().top;
            window.scrollTo({ top: y ? y + window.scrollY - offset : 0, behavior: "smooth" });
        },
    },
});
</script>